/*!
 * This file is part of Weaver.js 1.0.0-pre.
 * 
 * Weaver.js is free software: you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation, either version 3 of the License, or (at your option) any
 * later version.
 * 
 * Weaver.js is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 * 
 * You should have received a copy of the GNU Lesser General Public License along with
 * Weaver.js. If not, see <http://www.gnu.org/licenses/>.
 */
var weaver;!function(e){"use strict";var n=weaver=function(){};n.fn={},n.version="1.0.0-pre","undefined"!=typeof module&&module.exports&&(module.exports=weaver),"undefined"!=typeof define&&define.amd&&define("weaver",function(){return weaver}),e&&(e.weaver=weaver)}("undefined"==typeof window?null:window),function(e){"use strict";var n=0,t=1,r=2,i=function(e){return this instanceof i?(this.id="Thenable/1.0.7",this.state=n,this.fulfillValue=void 0,this.rejectReason=void 0,this.onFulfilled=[],this.onRejected=[],this.proxy={then:this.then.bind(this)},void("function"==typeof e&&e.call(this,this.fulfill.bind(this),this.reject.bind(this)))):new i(e)};i.prototype={fulfill:function(e){return a(this,t,"fulfillValue",e)},reject:function(e){return a(this,r,"rejectReason",e)},then:function(e,n){var t=this,r=new i;return t.onFulfilled.push(u(e,r,"fulfill")),t.onRejected.push(u(n,r,"reject")),o(t),r.proxy}};var a=function(e,t,r,i){return e.state===n&&(e.state=t,e[r]=i,o(e)),e},o=function(e){e.state===t?s(e,"onFulfilled",e.fulfillValue):e.state===r&&s(e,"onRejected",e.rejectReason)},s=function(e,n,t){if(0!==e[n].length){var r=e[n];e[n]=[];var i=function(){for(var e=0;e<r.length;e++)r[e](t)};"object"==typeof process&&"function"==typeof process.nextTick?process.nextTick(i):"function"==typeof setImmediate?setImmediate(i):setTimeout(i,0)}},u=function(e,n,t){return function(r){if("function"!=typeof e)n[t].call(n,r);else{var i;try{i=e(r)}catch(a){return void n.reject(a)}f(n,i)}}},f=function(e,n){if(e===n||e.proxy===n)return void e.reject(new TypeError("cannot resolve promise with itself"));var t;if("object"==typeof n&&null!==n||"function"==typeof n)try{t=n.then}catch(r){return void e.reject(r)}if("function"!=typeof t)e.fulfill(n);else{var i=!1;try{t.call(n,function(t){i||(i=!0,t===n?e.reject(new TypeError("circular thenable chain")):f(e,t))},function(n){i||(i=!0,e.reject(n))})}catch(r){i||e.reject(r)}}};e.Promise="undefined"==typeof Promise?i:Promise,e.Promise.all=e.Promise.all||function(n){return new e.Promise(function(e,t){for(var r=new Array(n.length),i=0,a=function(t,a){r[t]=a,i++,i===n.length&&e(r)},o=0;o<n.length;o++)!function(e){var r=n[e],i=null!=r.then;if(i)r.then(function(n){a(e,n)},function(e){t(e)});else{var o=r;a(e,o)}}(o)})}}(weaver),function(e,n){"use strict";var t="string",r=typeof{},i="function";e.is={defined:function(e){return null!=e},string:function(e){return null!=e&&typeof e==t},fn:function(e){return null!=e&&typeof e===i},array:function(e){return Array.isArray?Array.isArray(e):null!=e&&e instanceof Array},plainObject:function(n){return null!=n&&typeof n===r&&!e.is.array(n)&&n.constructor===Object},object:function(e){return null!=e&&typeof e===r},number:function(e){return null!=e&&"number"==typeof e&&!isNaN(e)},integer:function(n){return e.is.number(n)&&Math.floor(n)===n},bool:function(e){return null!=e&&typeof e==typeof!0},event:function(n){return n instanceof e.Event},thread:function(n){return n instanceof e.Thread},fabric:function(n){return n instanceof e.Fabric},emptyString:function(n){return n?e.is.string(n)&&(""===n||n.match(/^\s+$/))?!0:!1:!0},nonemptyString:function(n){return n&&e.is.string(n)&&""!==n&&!n.match(/^\s+$/)?!0:!1},domElement:function(e){return"undefined"==typeof HTMLElement?!1:e instanceof HTMLElement},promise:function(n){return e.is.object(n)&&e.is.fn(n.then)},touch:function(){return n&&("ontouchstart"in n||n.DocumentTouch&&document instanceof DocumentTouch)},gecko:function(){return"undefined"!=typeof InstallTrigger||"MozAppearance"in document.documentElement.style},webkit:function(){return"undefined"!=typeof webkitURL||"WebkitAppearance"in document.documentElement.style},chromium:function(){return"undefined"!=typeof chrome},khtml:function(){return navigator.vendor.match(/kde/i)},khtmlEtc:function(){return e.is.khtml()||e.is.webkit()||e.is.blink()},trident:function(){/*@cc_on!@*/
return"undefined"!=typeof ActiveXObject||!1},windows:function(){return"undefined"!=typeof navigator&&navigator.appVersion.match(/Win/i)},mac:function(){return"undefined"!=typeof navigator&&navigator.appVersion.match(/Mac/i)},linux:function(){return"undefined"!=typeof navigator&&navigator.appVersion.match(/Linux/i)},unix:function(){return"undefined"!=typeof navigator&&navigator.appVersion.match(/X11/i)}}}(weaver,"undefined"==typeof window?null:window),function(e){"use strict";e.util={extend:function(){var n,t,r,i,a,o,s=arguments[0]||{},u=1,f=arguments.length,c=!1;for("boolean"==typeof s&&(c=s,s=arguments[1]||{},u=2),"object"==typeof s||e.is.fn(s)||(s={}),f===u&&(s=this,--u);f>u;u++)if(null!=(n=arguments[u]))for(t in n)r=s[t],i=n[t],s!==i&&(c&&i&&(e.is.plainObject(i)||(a=e.is.array(i)))?(a?(a=!1,o=r&&e.is.array(r)?r:[]):o=r&&e.is.plainObject(r)?r:{},s[t]=e.util.extend(c,o,i)):void 0!==i&&(s[t]=i));return s},error:function(e){if(!console)throw e;if(console.error)console.error.apply(console,arguments);else{if(!console.log)throw e;console.log.apply(console,arguments)}}}}(weaver,"undefined"==typeof window?null:window),function(e){"use strict";function n(){return!1}function t(){return!0}e.Event=function(r,i){return this instanceof e.Event?(r&&r.type?(this.originalEvent=r,this.type=r.type,this.isDefaultPrevented=r.defaultPrevented?t:n):this.type=r,i&&(this.type=void 0!==i.type?i.type:this.type,this.namespace=i.namespace,this.layout=i.layout,this.data=i.data,this.message=i.message),void(this.timeStamp=r&&r.timeStamp||+new Date)):new e.Event(r,i)},e.Event.prototype={preventDefault:function(){this.isDefaultPrevented=t;var e=this.originalEvent;e&&e.preventDefault&&e.preventDefault()},stopPropagation:function(){this.isPropagationStopped=t;var e=this.originalEvent;e&&e.stopPropagation&&e.stopPropagation()},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=t,this.stopPropagation()},isDefaultPrevented:n,isPropagationStopped:n,isImmediatePropagationStopped:n}}(weaver),function(e){"use strict";e.define={event:{regex:/(\w+)(\.\w+)?/,optionalTypeRegex:/(\w+)?(\.\w+)?/,falseCallback:function(){return!1}},on:function(n){var t={unbindSelfOnTrigger:!1,unbindAllBindersOnTrigger:!1};return n=e.util.extend({},t,n),function(t,r,i){var a=this,o=void 0!==a.length,s=o?a:[a],u=e.is.string(t),f=n;if((e.is.fn(r)||r===!1)&&(i=r,r=void 0),!e.is.fn(i)&&i!==!1&&u)return a;if(u){var c={};c[t]=i,t=c}for(var l in t)if(i=t[l],i===!1&&(i=e.define.event.falseCallback),e.is.fn(i)){l=l.split(/\s+/);for(var p=0;p<l.length;p++){var v=l[p];if(!e.is.emptyString(v)){var d=v.match(e.define.event.regex);if(d)for(var h=d[1],g=d[2]?d[2]:void 0,m={callback:i,data:r,type:h,namespace:g,unbindSelfOnTrigger:f.unbindSelfOnTrigger,unbindAllBindersOnTrigger:f.unbindAllBindersOnTrigger,binders:s},y=0;y<s.length;y++){var b=s[y]._private;b.listeners=b.listeners||[],b.listeners.push(m)}}}}return a}},eventAliasesOn:function(n){var t=n;t.addListener=t.listen=t.bind=t.on,t.removeListener=t.unlisten=t.unbind=t.off,t.emit=t.trigger,t.pon=t.promiseOn=function(){var n=this,t=Array.prototype.slice.call(arguments,0);return new e.Promise(function(e){var r=function(t){n.off.apply(n,a),e(t)},i=t.concat([r]),a=i.concat([]);n.on.apply(n,i)})}},off:function(n){var t={};return n=e.util.extend({},t,n),function(n,t){var r=this,i=void 0!==r.length,a=i?r:[r],o=e.is.string(n);if(0===arguments.length){for(var s=0;s<a.length;s++)a[s]._private.listeners=[];return r}if(o){var u={};u[n]=t,n=u}for(var f in n){t=n[f],t===!1&&(t=e.define.event.falseCallback),f=f.split(/\s+/);for(var c=0;c<f.length;c++){var l=f[c];if(!e.is.emptyString(l)){var p=l.match(e.define.event.optionalTypeRegex);if(p)for(var v=p[1]?p[1]:void 0,d=p[2]?p[2]:void 0,s=0;s<a.length;s++)for(var h=a[s]._private.listeners=a[s]._private.listeners||[],g=0;g<h.length;g++){var m=h[g],y=!d||d===m.namespace,b=!v||m.type===v,w=!t||t===m.callback,j=y&&b&&w;j&&(h.splice(g,1),g--)}}}}return r}},trigger:function(n){var t={};return n=e.util.extend({},t,n),function(n,t,r){var i=this,a=void 0!==i.length,o=a?i:[i],s=e.is.string(n),u=e.is.plainObject(n),f=e.is.event(n);if(s){var c=n.split(/\s+/);n=[];for(var l=0;l<c.length;l++){var p=c[l];if(!e.is.emptyString(p)){var v=p.match(e.define.event.regex),d=v[1],h=v[2]?v[2]:void 0;n.push({type:d,namespace:h})}}}else if(u){var g=n;n=[g]}t?e.is.array(t)||(t=[t]):t=[];for(var l=0;l<n.length;l++)for(var m=n[l],y=0;y<o.length;y++){var p,b=o[y],w=b._private.listeners=b._private.listeners||[],j=!1;p=f?m:new e.Event(m,{namespace:m.namespace}),r&&(w=[{namespace:p.namespace,type:p.type,callback:r}]);for(var $=0;$<w.length;$++){var _=w[$],T=!_.namespace||_.namespace===p.namespace,k=_.type===p.type,S=!0,O=T&&k&&S;if(O){var P=[p];if(P=P.concat(t),p.data=_.data?_.data:void 0,(_.unbindSelfOnTrigger||_.unbindAllBindersOnTrigger)&&(w.splice($,1),$--),_.unbindAllBindersOnTrigger)for(var E=_.binders,x=0;x<E.length;x++){var A=E[x];if(A&&A!==b)for(var q=A._private.listeners,M=0;M<q.length;M++){var R=q[M];R===_&&(q.splice(M,1),M--)}}var L=b,F=_.callback.apply(L,P);(F===!1||p.isPropagationStopped())&&(j=!1,F===!1&&(p.stopPropagation(),p.preventDefault()))}}}return i}}}}(weaver),function(e,n){"use strict";e.Thread=function(n){if(!(this instanceof e.Thread))return new e.Thread(n);this._private={requires:[],queue:null,pass:[]};n&&this.run(n)},e.thread=e.Thread,e.thdfn=e.Thread.prototype,e.fn.thread=function(n){for(var t in n){var r=n[t];e.Thread.prototype[t]=r}};var t=function(n){var t=e.is.fn(n)?n.toString():'JSON.parse("'+JSON.stringify(n)+'")';return t},r=function(n){var a,o;e.is.object(n)&&n.fn?(a=i(n.fn,n.name),o=n.name,n=n.fn):e.is.fn(n)?(a=n.toString(),o=n.name):e.is.string(n)?a=n:e.is.object(n)&&(a=n.proto?"":n.name+" = {};",o=n.name,n=n.obj),a+="\n";var s=function(e,n){if(e.prototype){var t=!1;for(var i in e.prototype){t=!0;break}t&&(a+=r({name:n,obj:e,proto:!0},e))}};if(n.prototype&&null!=o)for(var u in n.prototype){var f="",c=n.prototype[u],l=t(c),p=o+".prototype."+u;f+=p+" = "+l+";\n",f&&(a+=f),s(c,p)}if(!e.is.string(n))for(var u in n){var v="";if(n.hasOwnProperty(u)){var c=n[u],l=t(c),p=o+'["'+u+'"]';v+=p+" = "+l+";\n"}v&&(a+=v),s(c,p)}return a};e.fn.thread({require:function(n,t){return t&&(e.is.fn(n)?(t=t||n.name,n={name:t,fn:n}):n={name:t,obj:n}),this._private.requires.push(n),this},pass:function(e){return this._private.pass.push(e),this},run:function(t,i){var a=this,o=this._private;if(i=i||o.pass.shift(),o.stopped)return void e.util.error("Attempted to run a stopped thread!  Start a new thread or do not stop the existing thread and reuse it.");if(o.running)return o.queue=o.queue.then(function(){return a.run(t,i)});a.trigger("run");var s=new e.Promise(function(s,u){o.running=!0;var f=o.ran,c=e.is.string(t)?t:t.toString(),l="\n"+o.requires.map(function(e){return r(e)}).concat(["( function(){","var ret = ("+c+")("+JSON.stringify(i)+");","if( ret !== undefined ){ resolve(ret); }","} )()\n"]).join("\n");if(o.requires=[],n){var p,v;if(!f){var d=l+"";l=["function broadcast(m){ return message(m); };","function message(m){ postMessage(m); };","function listen(fn){",'  self.addEventListener("message", function(m){ ','    if( typeof m === "object" && (m.data.$$eval || m.data === "$$start") ){',"    } else { ","      fn( m.data );","    }","  });","};",'self.addEventListener("message", function(m){  if( m.data.$$eval ){ eval( m.data.$$eval ); }  });',"function resolve(v){ postMessage({ $$resolve: v }); };","function reject(v){ postMessage({ $$reject: v }); };"].join("\n"),l+=d,p=new Blob([l],{type:"application/javascript"}),v=n.URL.createObjectURL(p)}var h=o.webworker=o.webworker||new Worker(v);f&&h.postMessage({$$eval:l});var g;h.addEventListener("message",g=function(n){e.is.object(n)&&e.is.object(n.data)&&"$$resolve"in n.data?(h.removeEventListener("message",g),s(n.data.$$resolve)):e.is.object(n)&&e.is.object(n.data)&&"$$reject"in n.data?(h.removeEventListener("message",g),u(n.data.$$reject)):a.trigger(new e.Event(n,{type:"message",message:n.data}))},!1),f||h.postMessage("$$start")}else if("undefined"!=typeof module){var g,m=require("path"),y=require("child_process"),b=o.child=o.child||y.fork(m.join(__dirname,"thread-node-fork"));b.on("message",g=function(n){e.is.object(n)&&"$$resolve"in n?(b.removeListener("message",g),s(n.$$resolve)):e.is.object(n)&&"$$reject"in n?(b.removeListener("message",g),u(n.$$reject)):a.trigger(new e.Event({},{type:"message",message:n}))}),b.send({$$eval:l})}else e.error("Tried to create thread but no underlying tech found!")}).then(function(e){return o.running=!1,o.ran=!0,a.trigger("ran"),e});return null==o.queue&&(o.queue=s),s},message:function(e){var n=this._private;return n.webworker&&n.webworker.postMessage(e),n.child&&n.child.send(e),this},stop:function(){var e=this._private;return e.webworker&&e.webworker.terminate(),e.child&&e.child.kill(),e.stopped=!0,this.trigger("stop")},stopped:function(){return this._private.stopped}});var i=function(e,n){var t=e.toString();return t=t.replace(/function.*\(/,"function "+n+"(")},a=function(e){return e=e||{},function(n,t){var r=i(n,"_$_$_"+e.name);return this.require(r),this.run(["function( data ){","  var origResolve = resolve;","  var res = [];","  ","  resolve = function( val ){","    res.push( val );","  };","  ","  var ret = data."+e.name+"( _$_$_"+e.name+(arguments.length>1?", "+JSON.stringify(t):"")+" );","  ","  resolve = origResolve;","  resolve( res.length > 0 ? res : ret );","}"].join("\n"))}};e.fn.thread({reduce:a({name:"reduce"}),reduceRight:a({name:"reduceRight"}),map:a({name:"map"})});var o=e.thdfn;o.promise=o.run,o.terminate=o.halt=o.stop,e.worker=e.Worker=e.Thread,e.fn.thread({on:e.define.on(),one:e.define.on({unbindSelfOnTrigger:!0}),off:e.define.off(),trigger:e.define.trigger()}),e.define.eventAliasesOn(e.thdfn)}(weaver,"undefined"==typeof window?null:window),function(e){"use strict";e.Fabric=function(n){if(!(this instanceof e.Fabric))return new e.Fabric(n);var t=(this._private={pass:[]},4);e.is.number(n),n="undefined"!=typeof navigator&&null!=navigator.hardwareConcurrency?navigator.hardwareConcurrency:"undefined"!=typeof module?require("os").cpus().length:t;for(var r=0;n>r;r++)this[r]=e.Thread();this.length=n},e.fabric=e.Fabric,e.fabfn=e.Fabric.prototype,e.fn.fabric=function(n){for(var t in n){var r=n[t];e.Fabric.prototype[t]=r}},e.fn.fabric({require:function(e,n){for(var t=0;t<this.length;t++){var r=this[t];r.require(e,n)}return this},random:function(){var e=Math.round((this.length-1)*Math.random()),n=this[e];return n},run:function(e){var n=this._private.pass.shift();return this.random().pass(n).run(e)},message:function(e){return this.random().message(e)},broadcast:function(e){for(var n=0;n<this.length;n++){var t=this[n];t.message(e)}return this},stop:function(){for(var e=0;e<this.length;e++){var n=this[e];n.stop()}return this},pass:function(n){var t=this._private.pass;return e.is.array(n)?t.push(n):e.util.error("Only arrays or collections may be used with fabric.pass()"),this},spreadSize:function(){var e=Math.ceil(this._private.pass[0].length/this.length);return e=Math.max(1,e)},spread:function(n){for(var t=this,r=t._private,i=t.spreadSize(),a=r.pass.shift().concat([]),o=[],s=0;s<this.length;s++){var u=this[s],f=a.splice(0,i),c=u.pass(f).run(n);o.push(c);var l=0===a.length;if(l)break}return e.Promise.all(o).then(function(e){for(var n=new Array,t=0,r=0;r<e.length;r++)for(var i=e[r],a=0;a<i.length;a++){var o=i[a];n[t++]=o}return n})},map:function(e){var n=this;return n.require(e,"_$_$_fabmap"),n.spread(function(e){var n=[],t=resolve;resolve=function(e){n.push(e)};for(var r=0;r<e.length;r++){var i=n.length,a=_$_$_fabmap(e[r]),o=i===n.length;o&&n.push(a)}return resolve=t,n})},filter:function(e){var n=this._private,t=n.pass[0];return this.map(e).then(function(e){for(var n=[],r=0;r<t.length;r++){var i=t[r],a=e[r];a&&n.push(i)}return n})},sort:function(e){{var n=this,t=this._private.pass[0].length,r=this.spreadSize();this.length}return e=e||function(e,n){return n>e?-1:e>n?1:0},n.require(e,"_$_$_cmp"),n.spread(function(e){var n=e.sort(_$_$_cmp);resolve(n)}).then(function(n){for(var i=function(r,i,a){i=Math.min(i,t),a=Math.min(a,t);for(var o=r,s=i,u=[],f=o;a>f;f++){var c=n[r],l=n[i];s>r&&(i>=a||e(c,l)<=0)?(u.push(c),r++):(u.push(l),i++)}for(var f=0;f<u.length;f++){var p=o+f;n[p]=u[f]}},a=r;t>a;a*=2)for(var o=0;t>o;o+=2*a)i(o,o+a,o+2*a);return n})}});var n=function(e){return e=e||{},function(n,t){var r=this._private.pass.shift();return this.random().pass(r)[e.threadFn](n,t)}};e.fn.fabric({randomMap:n({threadFn:"map"}),reduce:n({threadFn:"reduce"}),reduceRight:n({threadFn:"reduceRight"})});var t=e.fabfn;t.promise=t.run,t.terminate=t.halt=t.stop,e.fn.fabric({on:e.define.on(),one:e.define.on({unbindSelfOnTrigger:!0}),off:e.define.off(),trigger:e.define.trigger()}),e.define.eventAliasesOn(e.fabfn)}(weaver,"undefined"==typeof window?null:window);